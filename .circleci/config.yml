# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      - setup_remote_docker:
          version: 19.03.13
          docker_layer_caching: true
      - run:
          name: "Build branch docker image"
          command: make docker-build
      - run:
          name: "Push branch docker image"
          command: make docker-push
  test:
    docker:
      - image: cimg/python:3.10
    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      - checkout
      - setup_remote_docker:
          version: 19.03.13
          docker_layer_caching: true
      - run:
          name: "run tests"
          command: "make pipeline-test"
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: htmlcov
  release-patch:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      - run:
          name: "release patch"
          command: "make pipeline-release.patch"

  docs:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: make pip-install
      - run:
          name: Build docs
          command: "cd docs/ && make html"
      - persist_to_workspace:
          root: docs/_build
          paths:
          - html

# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  pull-requests:
    jobs:
      - test
      - docs:
          requires:
            - test
      - hold:
          filters:
            tags:
              only: /^\d+\.\d+\.\d+$/
          type: approval
          requires:
           - test
           - docs
      - release-patch:
          requires:
            - hold
      - build:
          requires:
            - hold
